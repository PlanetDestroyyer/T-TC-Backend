<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TinyCell NAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #060D18;
      --card: #0F1D2F;
      --card2: #162033;
      --border: #1E3048;
      --text: #EEF4FF;
      --muted: #7B9AB8;
      --dim: #3A5270;
      --blue: #3B8FF5;
      --green: #22C55E;
      --red: #F43F5E;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: rgba(6, 13, 24, .9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo-box {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, #3B8FF5, #8B5CF6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    header h1 {
      font-size: 16px;
      font-weight: 800;
    }

    header h1 span {
      color: #5BACFF;
    }

    .hdr-right {
      margin-left: auto;
      font-size: 12px;
      color: var(--dim);
    }

    /* â”€â”€ Layout â”€â”€ */
    .wrap {
      max-width: 760px;
      margin: 0 auto;
      padding: 32px 20px 80px;
    }

    /* â”€â”€ Drop zone â”€â”€ */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 20px;
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      margin-bottom: 24px;
    }

    .drop-zone:hover,
    .drop-zone.over {
      border-color: var(--blue);
      background: rgba(59, 143, 245, .05);
    }

    .drop-zone .dz-icon {
      font-size: 44px;
      margin-bottom: 14px;
      display: block;
    }

    .drop-zone h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .drop-zone p {
      color: var(--muted);
      font-size: 13px;
    }

    .drop-zone .choose-btn {
      display: inline-block;
      margin-top: 18px;
      background: var(--blue);
      color: #fff;
      border: none;
      padding: 10px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity .15s;
    }

    .drop-zone .choose-btn:hover {
      opacity: .85;
    }

    /* â”€â”€ Upload queue â”€â”€ */
    #upload-queue {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .uitem {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .uitem-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .uitem-info {
      flex: 1;
      min-width: 0;
    }

    .uitem-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .uitem-track {
      background: var(--card2);
      height: 4px;
      border-radius: 4px;
      margin-top: 6px;
      overflow: hidden;
    }

    .uitem-bar {
      background: var(--blue);
      height: 100%;
      border-radius: 4px;
      width: 0;
      transition: width .2s;
    }

    .uitem-pct {
      font-size: 11px;
      color: var(--muted);
      flex-shrink: 0;
      min-width: 30px;
      text-align: right;
    }

    .uitem.done .uitem-bar {
      background: var(--green);
      width: 100% !important;
    }

    .uitem.err .uitem-bar {
      background: var(--red);
    }

    /* â”€â”€ File list â”€â”€ */
    .file-list-header {
      display: flex;
      align-items: center;
      padding: 0 4px 10px;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }

    .file-list-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--dim);
      text-transform: uppercase;
      letter-spacing: .8px;
      flex: 1;
    }

    .file-count {
      font-size: 11px;
      color: var(--dim);
    }

    .file-list {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .file-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 16px;
      border-bottom: 1px solid var(--border);
      transition: background .12s;
      cursor: pointer;
    }

    .file-row:last-child {
      border-bottom: none;
    }

    .file-row:hover {
      background: var(--card2);
    }

    .file-row .ficon {
      font-size: 22px;
      width: 28px;
      text-align: center;
      flex-shrink: 0;
    }

    .file-row .finfo {
      flex: 1;
      min-width: 0;
    }

    .file-row .fname {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-row .fmeta {
      font-size: 11px;
      color: var(--dim);
      margin-top: 2px;
    }

    .file-row .fact {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .ibtn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      background: transparent;
      transition: background .15s;
    }

    .ibtn:hover {
      background: rgba(255, 255, 255, .06);
    }

    .ibtn.dl {
      color: #5BACFF;
    }

    .ibtn.dl:hover {
      background: rgba(59, 143, 245, .12);
    }

    .ibtn.del {
      color: var(--dim);
    }

    .ibtn.del:hover {
      background: rgba(244, 63, 94, .12);
      color: var(--red);
    }

    .chevron {
      color: var(--dim);
      font-size: 20px;
      font-weight: 300;
    }

    /* â”€â”€ Breadcrumb (inside file list header) â”€â”€ */
    .bc {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 13px;
      flex: 1;
      overflow: hidden;
    }

    .bc-back {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--blue);
      cursor: pointer;
      flex-shrink: 0;
    }

    .bc-seg {
      color: var(--muted);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .bc-seg:hover {
      color: var(--text);
      background: var(--card2);
    }

    .bc-seg.cur {
      color: var(--text);
      font-weight: 600;
      cursor: default;
    }

    .bc-sep {
      color: var(--dim);
    }

    /* â”€â”€ States â”€â”€ */
    .state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .state .si {
      font-size: 44px;
      display: block;
      margin-bottom: 12px;
    }

    .spinner {
      display: inline-block;
      width: 28px;
      height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* â”€â”€ Toast â”€â”€ */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(60px);
      background: var(--card2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 22px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      transition: all .3s;
      z-index: 99;
      box-shadow: 0 8px 32px rgba(0, 0, 0, .5);
      white-space: nowrap;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    #toast.ok {
      border-color: rgba(34, 197, 94, .4);
      color: var(--green);
    }

    #toast.err {
      border-color: rgba(244, 63, 94, .4);
      color: var(--red);
    }

    /* â”€â”€ Delete modal â”€â”€ */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(4px);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }

    .overlay.show {
      display: flex;
    }

    .modal {
      background: #0B1525;
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      width: 320px;
      max-width: 90vw;
      box-shadow: 0 24px 60px rgba(0, 0, 0, .6);
    }

    .modal h3 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .modal p {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 24px;
      word-break: break-all;
    }

    .modal-btns {
      display: flex;
      gap: 10px;
    }

    .modal-btns button {
      flex: 1;
      padding: 11px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      border: none;
    }

    .m-cancel {
      background: var(--card2);
      color: var(--text);
    }

    .m-del {
      background: var(--red);
      color: #fff;
    }

    #file-input {
      display: none;
    }
  </style>
</head>

<body>

  <header>
    <div class="logo-box">ğŸ’¾</div>
    <h1>Tiny<span>Cell</span> NAS</h1>
    <div class="hdr-right"><span id="hdr-info" style="font-size:12px;color:#6b85b0;"></span></div>
  </header>

  <div class="wrap">

    <!-- Upload zone -->
    <div class="drop-zone" id="drop-zone" onclick="triggerPick()">
      <span class="dz-icon">â˜ï¸</span>
      <h2>Upload Files</h2>
      <p>Drag & drop files here, or tap to choose from your device</p>
      <span class="choose-btn" onclick="triggerPick();event.stopPropagation()">Choose Files</span>
    </div>

    <!-- Per-file upload progress -->
    <div id="upload-queue"></div>

    <!-- File list -->
    <div id="file-section"></div>

  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Delete modal -->
  <div class="overlay" id="del-overlay">
    <div class="modal">
      <h3>ğŸ—‘ï¸ Delete file?</h3>
      <p id="del-name"></p>
      <div class="modal-btns">
        <button class="m-cancel" onclick="closeModal()">Cancel</button>
        <button class="m-del" onclick="doDelete()">Delete</button>
      </div>
    </div>
  </div>

  <input type="file" id="file-input" multiple onchange="handleFiles(this.files)">

  <script>
    const CHUNK = 5 * 1024 * 1024; // 5MB to prevent Cloudflare 100s timeout (HTTP 524)
    const ROOT = 'tinycell'; // single dedicated NAS folder â€” Download/TinyCell/
    let path = [];       // current folder segments
    let delTarget = null;

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const qs = p => Object.entries(p).map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
    const escH = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const esc = s => s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

    function fmtSize(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
      if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
      return (b / 1073741824).toFixed(2) + ' GB';
    }

    function fileIcon(name) {
      const ext = (name.split('.').pop() || '').toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'bmp'].includes(ext)) return 'ğŸ–¼ï¸';
      if (['mp4', 'mkv', 'avi', 'mov', 'webm', '3gp'].includes(ext)) return 'ğŸ¬';
      if (['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg'].includes(ext)) return 'ğŸµ';
      if (ext === 'pdf') return 'ğŸ“„';
      if (['zip', 'tar', 'gz', 'rar', '7z'].includes(ext)) return 'ğŸ“¦';
      if (['doc', 'docx', 'txt', 'md'].includes(ext)) return 'ğŸ“';
      if (['xls', 'xlsx', 'csv'].includes(ext)) return 'ğŸ“Š';
      if (ext === 'apk') return 'ğŸ“±';
      if (['js', 'ts', 'py', 'go', 'json', 'html', 'css'].includes(ext)) return 'ğŸ’»';
      return 'ğŸ“„';
    }

    function toast(msg, type = '') {
      const el = document.getElementById('toast');
      el.textContent = msg; el.className = 'show' + (type ? ' ' + type : '');
      clearTimeout(el._t); el._t = setTimeout(() => el.className = '', 3000);
    }

    function setSection(html) { document.getElementById('file-section').innerHTML = html; }

    // â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dz = document.getElementById('drop-zone');
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('over'));
    dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); handleFiles(e.dataTransfer.files); });

    function triggerPick() { document.getElementById('file-input').click(); }

    // â”€â”€ Load directory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDir() {
      setSection('<div class="state"><div class="spinner"></div></div>');
      try {
        const p = path.join('/');
        const q = qs(p ? { root: ROOT, path: p } : { root: ROOT });
        const res = await fetch(`/nas/browse?${q}`);
        const text = await res.text();
        let r;
        try {
          r = JSON.parse(text);
        } catch (_) {
          throw new Error(`Server returned non-JSON (HTTP ${res.status}): ${text.slice(0, 200)}`);
        }
        if (r.error) throw new Error(r.error);
        if (r.detail) throw new Error(r.detail);  // FastAPI's default error shape
        renderFiles(r.items || []);
      } catch (e) {
        setSection(`<div class="state"><span class="si">âš ï¸</span><p style="color:var(--red)">${escH(e.message)}</p></div>`);
      }
    }

    function renderFiles(items) {
      const sorted = [...items.filter(i => i.is_dir), ...items.filter(i => !i.is_dir)];
      const count = items.filter(i => !i.is_dir).length;
      document.getElementById('hdr-info').textContent = `${count} file${count !== 1 ? 's' : ''}`;

      // Breadcrumb header
      const bcParts = path.map((seg, i) => `<span class="bc-sep">/</span><span class="bc-seg${i === path.length - 1 ? ' cur' : ''}" onclick="navTo(${i})">${escH(seg)}</span>`).join('');

      const header = `
    <div class="file-list-header">
      <div class="bc">
        ${path.length > 0 ? `<span class="bc-back" onclick="goBack()">â€¹ Back</span>` : ''}
        <span class="bc-seg cur" onclick="navTo(-1)">ğŸ“± Storage</span>
        ${bcParts}
      </div>
      <span class="file-count">${sorted.length} item${sorted.length !== 1 ? 's' : ''}</span>
    </div>`;

      if (sorted.length === 0) {
        setSection(header + '<div class="state"><span class="si">ğŸ“‚</span><p>Empty folder â€” upload something!</p></div>');
        return;
      }

      const rows = sorted.map(item => {
        const icon = item.is_dir ? 'ğŸ“' : fileIcon(item.name);
        const meta = item.is_dir ? 'Folder' : fmtSize(item.size);
        const right = item.is_dir
          ? `<span class="chevron">â€º</span>`
          : `<div class="fact">
          <button class="ibtn dl"  title="Download" onclick="dlFile('${esc(item.name)}');event.stopPropagation()">â¬‡</button>
          <button class="ibtn del" title="Delete"   onclick="askDel('${esc(item.name)}');event.stopPropagation()">ğŸ—‘</button>
        </div>`;
        const click = item.is_dir ? `openDir('${esc(item.name)}')` : `openFile('${esc(item.name)}')`;
        return `
      <div class="file-row" onclick="${click}">
        <span class="ficon">${icon}</span>
        <div class="finfo">
          <div class="fname">${escH(item.name)}</div>
          <div class="fmeta">${meta}</div>
        </div>
        ${right}
      </div>`;
      }).join('');

      setSection(header + `<div class="file-list">${rows}</div>`);
    }

    function openDir(name) { path.push(name); loadDir(); }
    function goBack() { if (path.length > 0) { path.pop(); loadDir(); } }
    function navTo(i) { if (i < 0) { path = []; loadDir(); } else { path = path.slice(0, i + 1); loadDir(); } }
    // Open inline â€” browser shows images/PDFs/videos; falls back to download for others
    function openFile(name) { window.open(`/nas/download?${qs({ root: ROOT, path: [...path, name].join('/') })}`, '_blank'); }
    // Force Save dialog via ?download=1
    function dlFile(name) { window.open(`/nas/download?${qs({ root: ROOT, path: [...path, name].join('/') })}&download=1`, '_blank'); }

    // â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function askDel(name) { delTarget = name; document.getElementById('del-name').textContent = name; document.getElementById('del-overlay').classList.add('show'); }
    function closeModal() { delTarget = null; document.getElementById('del-overlay').classList.remove('show'); }
    async function doDelete() {
      if (!delTarget) return;
      const name = delTarget; closeModal();
      try {
        const r = await fetch(`/nas/delete?${qs({ root: ROOT, path: [...path, name].join('/') })}`, { method: 'DELETE' }).then(r => r.json());
        if (r.error) throw new Error(r.error);
        toast(`âœ“ Deleted`, 'ok'); loadDir();
      } catch (e) { toast(`Error: ${e.message}`, 'err'); }
    }

    // â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleFiles(files) {
      if (!files.length) return;
      const fileArr = Array.from(files);            // snapshot BEFORE clearing â€” FileList is a live DOM object
      document.getElementById('file-input').value = '';
      const qEl = document.getElementById('upload-queue');

      const list = fileArr.map(file => {
        const id = 'u' + Math.random().toString(36).slice(2);
        const html = `
      <div class="uitem" id="${id}">
        <span class="uitem-icon">${fileIcon(file.name)}</span>
        <div class="uitem-info">
          <div class="uitem-name">${escH(file.name)}</div>
          <div class="uitem-track"><div class="uitem-bar" id="${id}b"></div></div>
        </div>
        <span class="uitem-pct" id="${id}p">0%</span>
      </div>`;
        qEl.insertAdjacentHTML('beforeend', html);
        return { file, id };
      });

      for (const { file, id } of list) {
        const barEl = document.getElementById(id + 'b');
        const pctEl = document.getElementById(id + 'p');
        try {
          // Always use chunked â€” Cloudflare quick tunnels drop connections
          // every ~2 min; chunked with retry survives those drops.
          await uploadChunked(file, pct => { barEl.style.width = pct + '%'; pctEl.textContent = Math.round(pct) + '%'; });
          document.getElementById(id)?.classList.add('done');
          pctEl.textContent = 'âœ“';
          toast(`âœ“ ${file.name} uploaded`, 'ok');
        } catch (e) {
          document.getElementById(id)?.classList.add('err');
          pctEl.textContent = 'âœ—';
          toast(`âœ— ${file.name}: ${e.message}`, 'err');
        }
      }

      setTimeout(() => { qEl.innerHTML = ''; loadDir(); }, 1200);
    }

    function uploadFile(file, onProg) {
      return new Promise((resolve, reject) => {
        const dir = path.join('/');
        const form = new FormData();
        form.append('file', file, file.name);
        const q = qs(dir ? { root: ROOT, path: dir } : { root: ROOT });
        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = e => { if (e.lengthComputable) onProg(e.loaded / e.total * 95); };
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) { onProg(100); resolve(); }
          else {
            let msg = `HTTP ${xhr.status}`;
            try { const j = JSON.parse(xhr.responseText); msg = j.error || msg; } catch (_) { }
            reject(new Error(msg));
          }
        };
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.open('POST', `/nas/upload?${q}`);
        xhr.send(form);
      });
    }

    // Chunked upload â€” adaptive sizing targeting 10s per chunk, with retry.
    // Small chunks (512 KB start) survive Cloudflare quick-tunnel connection drops
    // (~2 min cycle). Each chunk is retried up to 3 times on network failure.
    async function uploadChunked(file, onProg) {
      const TARGET_TIME_S = 10;          // target each chunk to finish in ~10s
      const MIN_CHUNK = 256 * 1024;      // 256 KB minimum
      const MAX_CHUNK = 4 * 1024 * 1024; // 4 MB maximum
      const MAX_RETRIES = 3;
      let currentChunkSize = 512 * 1024; // start at 512 KB

      const dir = path.join('/');
      let offset = 0;
      let chunkIndex = 0;

      while (offset < file.size) {
        const bytesRemaining = file.size - offset;
        const sendBytes = Math.min(bytesRemaining, currentChunkSize);
        const chunk = file.slice(offset, offset + sendBytes);
        const isLast = (offset + sendBytes) >= file.size;

        const q = qs({ root: ROOT, path: dir, filename: file.name, chunk_index: chunkIndex, is_last: isLast });

        let res, startTime, endTime;
        for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
          if (attempt > 0) {
            await new Promise(r => setTimeout(r, 2000 * attempt)); // back-off before retry
          }
          const form = new FormData();
          form.append('file', chunk, file.name);
          startTime = performance.now();
          try {
            res = await fetch(`/nas/upload-chunk?${q}`, { method: 'POST', body: form });
            endTime = performance.now();
            if (res.ok) break;
            if (attempt === MAX_RETRIES) {
              let msg = `chunk ${chunkIndex} HTTP ${res.status}`;
              try { const j = await res.json(); msg = j.error || msg; } catch (_) {}
              throw new Error(msg);
            }
          } catch (e) {
            if (attempt === MAX_RETRIES) throw e;
            // network error â€” retry
          }
        }

        offset += sendBytes;
        chunkIndex++;
        onProg((offset / file.size) * 100);

        // Adapt chunk size to hit TARGET_TIME_S
        const durationS = (endTime - startTime) / 1000;
        if (durationS > 0) {
          const newSize = Math.floor(currentChunkSize * (TARGET_TIME_S / durationS));
          currentChunkSize = Math.max(MIN_CHUNK, Math.min(MAX_CHUNK, newSize));
        }
      }
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadDir();
  </script>
</body>

</html>